//@version=6
// INDICATOR: Bearish RSI Divergence on RSI Chart

indicator("Bearish RSI Divergence on RSI Chart")

// Inputs
rsiLength = input.int(14, title="RSI Length")
pivotLookback = input.int(5, title="Pivot Lookback Period")
rsiStrengthLevel = input.int(60, title="Min RSI Level for Divergence")

// Calculations 
rsiValue = ta.rsi(close, rsiLength)

// Find the last pivot high points in both price and RSI
pivotHighPrice = ta.pivothigh(high, pivotLookback, pivotLookback)
pivotHighRsi = ta.pivothigh(rsiValue, pivotLookback, pivotLookback)

// Divergence Logic 
var float lastPivotPrice = na
var float lastPivotRsi = na
var int lastPivotBarIndex = na

bool bearishDivergence = false

// When a new RSI pivot high is detected...
if not na(pivotHighRsi)
   // Check for the divergence condition
   if not na(lastPivotPrice) and pivotHighPrice > lastPivotPrice and pivotHighRsi < lastPivotRsi
       bearishDivergence := true
       // Draw a line on the chart connecting the two price peaks
       line.new(bar_index[pivotLookback], pivotHighPrice, lastPivotBarIndex, lastPivotPrice, color=color.new(color.red, 50), width=2)
       // Draw a line on the RSI pane connecting the two RSI peaks
       line.new(bar_index[pivotLookback], pivotHighRsi, lastPivotBarIndex, lastPivotRsi, color=color.new(color.red, 50), width=2)
  
   // Update the 'last pivot' values for the next comparison
   lastPivotPrice := pivotHighPrice
   lastPivotRsi := pivotHighRsi
   lastPivotBarIndex := bar_index[pivotLookback]

// Plotting & Visuals 

// Plot the RSI line itself
plot(rsiValue, "RSI", color.orange)

// Plot the key horizontal levels
hline(70, "Overbought", color.red, linestyle=hline.style_dashed)
hline(30, "Oversold", color.green, linestyle=hline.style_dashed)

// Add a clear visual marker on the RSI pane when a divergence is confirmed
plotshape(series=bearishDivergence, title="Bearish Divergence", location=location.abovebar, color=color.new(color.red, 0), style=shape.labeldown, text="SELL\nDIV", textcolor=color.white, size=size.small)
